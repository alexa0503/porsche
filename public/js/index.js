function logEvent(e){var t=$("#image").offset();$("#logInfo").html(JSON.stringify(transform)+" type:"+e.type+" rotation:"+e.rotation+" offset:"+JSON.stringify(t))}function resetElement(){el.className="animate",transform={translate:{x:START_X,y:START_Y},scale:initScale,angle:initAngle,rx:0,ry:0,rz:1},requestElementUpdate()}function updateElementTransform(){var e=["translate3d("+transform.translate.x+"px, "+transform.translate.y+"px, 0)","scale("+transform.scale+", "+transform.scale+")","rotate3d("+transform.rx+","+transform.ry+","+transform.rz+","+transform.angle+"deg)"];e=e.join(" "),el.style.webkitTransform=e,el.style.mozTransform=e,el.style.transform=e,ticking=!1}function requestElementUpdate(){ticking||(reqAnimationFrame(updateElementTransform),ticking=!0)}function onPan(e){el.className="","panstart"==e.type?(START_X=transform.translate.x||START_X,START_Y=transform.translate.y||START_Y,transform.translate={x:START_X,y:START_Y}):transform.translate={x:START_X+e.deltaY,y:START_Y-e.deltaX},logEvent(e),requestElementUpdate()}function onPinch(e){"pinchstart"==e.type&&(initScale=transform.scale||initScale),el.className="",transform.scale=initScale*e.scale,logEvent(e),requestElementUpdate()}function onRotate(e){el.className="",transform.rz=1;var t=e.rotation-start_angel;"rotatestart"==e.type?start_angel=e.rotation:(start_angel=e.rotation,transform.angle+=t),logEvent(e),requestElementUpdate()}function onSwipe(e){transform.ry=e.direction&Hammer.DIRECTION_HORIZONTAL?1:0,transform.rx=e.direction&Hammer.DIRECTION_VERTICAL?1:0,transform.angle=e.direction&(Hammer.DIRECTION_RIGHT|Hammer.DIRECTION_UP)?angle:-angle,clearTimeout(timer),timer=setTimeout(function(){resetElement()},300),logEvent(e),requestElementUpdate()}function onTap(e){transform.rx=1,transform.angle=25,clearTimeout(timer),timer=setTimeout(function(){resetElement()},200),logEvent(e),requestElementUpdate()}function onDoubleTap(e){transform.rx=1,transform.angle=80,clearTimeout(timer),timer=setTimeout(function(){resetElement()},500),logEvent(e),requestElementUpdate()}function upload(e){var t="/wx/"+e;$.ajax({url:t,dataType:"json",method:"GET"}).done(function(e){if(0==e.ret){nWidth=e.data.width,nHeight=e.data.height;if(getMinScale(nWidth,nHeight)>1)return void alert("图片太小，请重新上传");$("#image").show();var t=$("#image");t.width(nWidth*screenScale),t.height(nHeight*screenScale),t.attr("src",e.data.url),initScale=1,initAngle=0,START_X=0,START_Y=0,resetElement()}}).fail(function(e,t,n){alert("上传失败，请稍候重试")}).always(function(){})}function getMinScale(e,t){if(600/t>498/e)var n=498/e;else var n=600/t;return n}var reqAnimationFrame=function(){return window[Hammer.prefixed(window,"requestAnimationFrame")]||function(e){window.setTimeout(e,1e3/60)}}(),screen=window.screen,hitArea=document.querySelector("#hitarea"),el=document.querySelector("#image"),START_X=0,START_Y=0,initScale=1,initAngle=0,ticking=!1,screenScale=screen.height/1334,transform,timer,mc=new Hammer.Manager(hitArea);mc.add(new Hammer.Pan({threshold:0,pointers:0})),mc.add(new Hammer.Swipe).recognizeWith(mc.get("pan")),mc.add(new Hammer.Rotate({threshold:0})).recognizeWith(mc.get("pan")),mc.add(new Hammer.Pinch({threshold:0})).recognizeWith([mc.get("pan"),mc.get("rotate")]),mc.on("panstart panmove",onPan),mc.on("rotatestart rotatemove",onRotate),mc.on("pinchstart pinchmove",onPinch),mc.on("hammer.input",function(e){e.isFinal});var start_angel=0;$().ready(function(){var e=!1;$(".btn-photo,.btn-upload").on("touchend",function(){return void upload("local")}),$(".n4 .btns .btn-sure").on("touchend",function(){if(void 0===transform)return alert("请上传图片"),!1;if(e)return alert("请等待图片处理"),!1;e=!0;var t=$("#image").offset(),n=transform.scale,a=transform.angle,r=-1*t.top,o=-1*t.left,i={x:r/screenScale,y:o/screenScale,scale:n,angle:a,screenScale:screenScale,w:screen.width/screenScale,h:screen.height/screenScale,_token:window.Laravel.csrfToken};SiteEvt.dis("exeing"),$("#image").hide(),$.post("/cartoon",i,function(e){0==e.ret?(ABC.isstatic=!1,SiteEvt.dis("imgok",{path:e.images.path}),SiteEvt.dis("exeok")):alert("处理失败")}).fail(function(){e=!1,alert("图片处理失败,请重试")})})});