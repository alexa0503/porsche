function logEvent(e){$("#image").offset()}function resetElement(){el.className="animate",transform={translate:{x:START_X,y:START_Y},scale:initScale,angle:initAngle,rx:0,ry:0,rz:1},requestElementUpdate()}function updateElementTransform(){var e=["translate3d("+transform.translate.x+"px, "+transform.translate.y+"px, 0)","scale("+transform.scale+", "+transform.scale+")","rotate3d("+transform.rx+","+transform.ry+","+transform.rz+","+transform.angle+"deg)"];e=e.join(" "),el.style.webkitTransform=e,el.style.mozTransform=e,el.style.transform=e,ticking=!1}function requestElementUpdate(){ticking||(reqAnimationFrame(updateElementTransform),ticking=!0)}function onPan(e){el.className="","panstart"==e.type?(START_X=transform.translate.x||START_X,START_Y=transform.translate.y||START_Y,transform.translate={x:START_X,y:START_Y}):window.innerHeight<window.innerWidth?transform.translate={x:START_X+e.deltaX,y:START_Y+e.deltaY}:transform.translate={x:START_X+e.deltaY,y:START_Y-e.deltaX},logEvent(e),requestElementUpdate()}function onPinch(e){"pinchstart"==e.type&&(initScale=transform.scale||initScale),el.className="",transform.scale=initScale*e.scale,logEvent(e),requestElementUpdate()}function onRotate(e){el.className="",transform.rz=1;var n=e.rotation-start_angel;"rotatestart"==e.type?start_angel=e.rotation:(start_angel=e.rotation,transform.angle+=n),logEvent(e),requestElementUpdate()}function onSwipe(e){transform.ry=e.direction&Hammer.DIRECTION_HORIZONTAL?1:0,transform.rx=e.direction&Hammer.DIRECTION_VERTICAL?1:0,transform.angle=e.direction&(Hammer.DIRECTION_RIGHT|Hammer.DIRECTION_UP)?angle:-angle,clearTimeout(timer),timer=setTimeout(function(){resetElement()},300),logEvent(e),requestElementUpdate()}function onTap(e){transform.rx=1,transform.angle=25,clearTimeout(timer),timer=setTimeout(function(){resetElement()},200),logEvent(e),requestElementUpdate()}function onDoubleTap(e){transform.rx=1,transform.angle=80,clearTimeout(timer),timer=setTimeout(function(){resetElement()},500),logEvent(e),requestElementUpdate()}function upload(e){var n="/wx/"+e+"?gender="+ABC.gender;$.ajax({url:n,dataType:"json",method:"GET"}).done(function(e){if(0==e.ret){nWidth=e.data.width,nHeight=e.data.height;if(getMinScale(nWidth,nHeight)>1)return void alert("图片太小，请重新上传");var n=$("#image");n.width(nWidth*screenScale),n.height(nHeight*screenScale),n.attr("src",e.data.url),$("#image").show(),initScale=1,initAngle=0,START_X=0,START_Y=0,resetElement()}}).fail(function(e,n,t){alert("上传失败，请稍候重试")}).always(function(){})}function getMinScale(e,n){if(520/n>390/e)var t=390/e;else var t=520/n;return t}var reqAnimationFrame=function(){return window[Hammer.prefixed(window,"requestAnimationFrame")]||function(e){window.setTimeout(e,1e3/60)}}(),screen=window.screen,hitArea=document.querySelector("#hitarea"),el=document.querySelector("#image"),START_X=0,START_Y=0,initScale=1,initAngle=0,ticking=!1,screenScale=window.innerHeight/1334;window.innerHeight<window.innerWidth&&(screenScale=window.innerWidth/1334);var transform,timer,mc=new Hammer.Manager(hitArea);mc.add(new Hammer.Pan({threshold:0,pointers:0})),mc.add(new Hammer.Swipe).recognizeWith(mc.get("pan")),mc.add(new Hammer.Rotate({threshold:0})).recognizeWith(mc.get("pan")),mc.add(new Hammer.Pinch({threshold:0})).recognizeWith([mc.get("pan"),mc.get("rotate")]),mc.on("panstart panmove",onPan),mc.on("rotatestart rotatemove",onRotate),mc.on("pinchstart pinchmove",onPinch),mc.on("hammer.input",function(e){e.isFinal});var start_angel=0;$().ready(function(){$(window).resize(function(){screenScale=window.innerHeight<window.innerWidth?window.innerWidth/1334:window.innerHeight/1334});var e=!1;$(".btn-photo,.btn-upload").on("touchend",function(){if(e)return alert("请等待图片处理"),!1;ABC.inUploadPhotoDisableClue=!0;var n=["album","camera"];wx.chooseImage({count:1,sizeType:["compressed"],sourceType:n,complete:function(){setTimeout(function(){ABC.inUploadPhotoDisableClue=!1},3e3)},cancel:function(){ABC.inUploadPhotoDisableClue=!1},success:function(e){var n=e.localIds;setTimeout(function(){wx.uploadImage({localId:n[0],isShowProgressTips:2,success:function(e){upload(e.serverId)}})},100)}})}),$(".n4 .btns .btn-sure").on("touchend",function(){if(void 0===transform)return alert("请上传图片"),!1;if(e)return alert("请等待图片处理"),!1;e=!0;var n=$("#image").offset(),t=transform.scale,a=transform.angle,r=-1*n.top,i=-1*n.left,o={x:r/screenScale,y:i/screenScale,scale:t,angle:a,screenScale:screenScale,w:window.innerWidth/screenScale,h:window.innerHeight/screenScale,_token:window.Laravel.csrfToken};SiteEvt.dis("exeing"),$("#image").hide(),$.post("/cartoon",o,function(n){0==n.ret?(ABC.isstatic=!1,SiteEvt.dis("imgok",{path:n.images.path}),$(".n5 .btns_ .btn-again").show(),$(".n5 .btns_ .bnt-sure").show(),$(".n5").show(),$(".n4").hide(),$(".game-main-body").show(),SiteEvt.dis("exeok"),wx&&wxData&&(wxData.link=n.shareUrl,wxShare(wxData))):(alert("处理失败"),e=!1)}).fail(function(){e=!1,alert("图片处理失败,请重试")})}),$(".n5 .btns_ .btn-again").hide(),$(".n5 .btns_ .bnt-sure").hide(),$(".n5 .btns_ .btn-again").on("click",function(){$(".n5").hide(),$(".n4").show(),$(".game-main-body").hide(),e=!1}),$(".n5 .btns_ .bnt-sure").on("click",function(){cn5.load()})});